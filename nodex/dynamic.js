"use strict";function execAfterAdd(a){var b=require("child_process").exec,c=b("jscriptify "+__dirname+"/tempfile.js > "+__dirname+"/callbacks.js");c.on("close",function(b){isConsole&&console.log("Finished Register CallBacks"),a&&a(),forkCallBacks()})}function getTaskPids(){var a=require("child_process").exec;a("tasklist",function(a,b){var c=b.split("\n"),d="cscript.exe",e=[];if(c&&c.length)for(var f=0;f<c.length;f++){var g=/(.+.exe.+?\d+)/i,h=c[f].match(g);if(h&&h.length)for(var i=0;i<h.length;i++)if(-1!=h[i].search(d)){var j={},k=h[i].split("exe")[1].trim();j.name=d,j.pid=k,e.push(j)}}getpids=e})}function killByPid(a){isConsole&&console.log("---CLOSE-NODE-X---");var b=require("child_process").exec;if(a&&a.length)for(var c=0;c<a.length;c++)b("taskkill /F /pid "+a[c].pid)}function forkCallBacks(){var a=require("child_process",{maxBuffer:1536e3}).fork;callbackx=a(__dirname+"/activex.js"),console.log("---FORK---:"+__dirname),callbackx.on("message",function(a){answerExec&&answerExec(a),getTaskPids()}),clearTempFile()}function clearTempFile(){var a=require("fs"),b=__dirname+"/tempfile.js";a.unlinkSync(b)}function registerDevice(a){var b={};b.deviceType=a.deviceType,b.guid=a.guid,b.prefix=a.deviceType,arrDevice.push(b),isConsole&&console.log("---REGISTER--IN--CALLBACKS---: "+a.deviceType)}function writeCallBackPrefix(a){var b=require("fs"),c=b.createWriteStream(__dirname+"/tempfile.js");c.write(templateExec()),c.end(),c.on("finish",function(){console.log("---END---STREAM: "),execAfterAdd(a)})}function uniqueid(){var a=String.fromCharCode(Math.floor(25*Math.random()+65));do{var b=Math.floor(42*Math.random()+48);(58>b||b>64)&&(a+=String.fromCharCode(b))}while(a.length<32);return a}function registerCallBack(a,b){for(var c=0;c<arrDevice.length;c++)arrDevice[c].deviceType==a&&(arrDevice[c].hasOwnProperty("callbacks")||(arrDevice[c].callbacks=[]),arrDevice[c].callbacks.push(b));isConsole&&console.log("---REGISTER_CALLBACK---: "+b)}function templateExec(){var a="while(!WScript.StdIn.AtEndOfStream) {var  call = JSON.parse( WScript.StdIn.ReadLine() );log( call );while (true)   { WScript.sleep(1000); };}function log( data ){WScript.StdOut.Write( JSON.stringify( data ) + '\\n' );};";return getRegisterLines(arrDevice)+a}function getRegisterLines(a){for(var b="var JSON = require('json3');\n",c=[],d=0;d<a.length;d++)a[d].callbacks&&(b+="var register_"+d+" = WScript.CreateObject('"+a[d].guid+"', '"+a[d].prefix+"_');\n",c.push(getCallBackLines(a[d].callbacks,a[d].prefix)));return c.length&&(b+=c.join("\n")),b}function getCallBackLines(a,b){function c(a,b){function c(a){if(""==a)return"{}";var b="{";if(!a&&!a.length)return"{}";for(var c=0;c<a.length;c++){if(1==a.length)return a[c];b+=a[c]+":"+a[c],c!=a.length-1&&(b+=",")}return b+"}"}var d=a.split(","),e="function "+b+"("+a+"){var datasend = {};datasend.callBackType='"+b+"';datasend.data="+c(d)+";WScript.StdOut.Write( JSON.stringify(datasend) + '\\n');}\n";return e}for(var d="",e=0;e<a.length;e++){var f=a[e].split("("),g=f[0],h=f[1].split(")")[0];d+=b+"_"+g+"="+g+";\n",d+=c(h,g)}return d}var arrDevice=[],isConsole=!0,answerExec,callbackx,getpids,_=function(){function a(a){a.deviceType&&a.guid&&registerDevice(a)}function b(a){a.deviceType&&a.callBack&&registerCallBack(a.deviceType,a.callBack)}function c(a){writeCallBackPrefix(a)}function d(){isConsole&&console.log("---CLOSE-CALLBACKS---"),killByPid(getpids)}function e(a){answerExec=a}function f(a){isConsole=a}return{registerDevice:a,registerCallBack:b,endRegister:c,setConsole:f,answer:e,close:d}}();module.exports=_;